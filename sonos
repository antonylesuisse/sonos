#!/usr/bin/env python3
# by Antony Lesuisse 2020, public domain
import os
import re
import select
import socket
import subprocess
import sys
from typing import Any, List, Optional, Union

import soco  # type: ignore[import]

HTTP_PORT = 8888
STREAM_NAME = "linux_to_sonos.flac"


def get_ip() -> Any:
    """
    Return the main IP address of the system

    Returns:
        Any: IP address
    """
    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    sock.settimeout(0)
    try:
        # doesn't even have to be reachable
        sock.connect(('10.255.255.255', 1))
        ip_addr = sock.getsockname()[0]
    except socket.gaierror:
        ip_addr = '127.0.0.1'
    finally:
        sock.close()
    return ip_addr


def run(cmd: str, shell: bool = False) -> str:
    """
    Function to run a command and return output

    Args:
        cmd (str): command to run
        shell (bool, optional): Whether the supplied command should utilise the shell.
            Defaults to False.

    Returns:
        str: _description_
    """
    command: Union[str, List[str]]
    if '|' in cmd:
        shell = True
        command = cmd
    else:
        command = cmd.split(' ')
    try:
        proc = subprocess.run(
            command,
            shell=shell,
            stdout=subprocess.PIPE,
            stderr=subprocess.STDOUT,
            check=True,
        )
    except subprocess.CalledProcessError as error:
        print(f'Command "{" ".join(error.cmd)}" failed: {error.stdout.decode("utf-8")}')
        return ''

    return proc.stdout.decode('utf-8').strip()


def sonos_discover(preferred: str = '') -> Optional[soco.core.SoCo]:
    """
    Discover a Sonos speaker

    Args:
        preferred (str, optional): IP of preferred Sonos device. Defaults to ''.

    Returns:
        Optional[soco.core.SoCo]: Sonos device found
    """
    for device in soco.discover():
        if not preferred:
            print(
                'No preferred Sonos device.  Returning the first one found: '
                f'{device.player_name}'
            )
            return device
        if preferred == device.ip_address:
            print(f'Preferred Sonos device found: {device.player_name}')
            return device

    return None


def sonos_play(sonos: soco.core.SoCo, volume: int) -> None:
    """
    Play content on the Sonos device

    Args:
        sonos (soco.core.SoCo): Sonos device
        volume (int): Volume level to set
    """
    sonos.clear_queue()
    sonos.add_uri_to_queue(f'http://{get_ip()}:{HTTP_PORT}/{STREAM_NAME}')
    sonos.play_from_queue(0)
    sonos.volume = volume
    sonos.play()


def sonos_volume(sonos: soco.core.SoCo) -> None:
    output = run('amixer sget Master,0')
    line = re.findall(r' \[([0-9]*)%\] ', output)
    volume = int(line[0])
    if volume != 75:
        volume_delta = volume - 75
        print(f'local volume is {volume} delta 75 {volume_delta}')
        sonos_volume = sonos.volume
        sonos.volume = sonos_volume + volume_delta
        print(f'volume from sv {sonos_volume} to {sonos_volume + volume_delta}:')
        run('pactl set-sink-volume Sonos 75%')


def pa_sink_load() -> None:
    output = run('pactl list sinks short')
    if not 'Sonos' in output:
        sink = run("pactl list sinks short | awk '{print $2}'| head -1").strip()
        run(
            'pacmd load-module module-combine-sink sink_name=Sonos '
            f'sink_properties=device.description=Sonos slaves={sink} channels=2'
        )
        run('pactl set-sink-volume Sonos 75%')
        run(f'pactl set-sink-volume {sink} 0%')
        run('pactl set-default-sink Sonos')


def pa_sink_unload() -> None:
    sink = run("pactl list sinks short | awk '{print $2}'| head -1").strip()
    run(f'pactl set-default-sink {sink}')
    run('pacmd unload-module module-combine-sink')


def vlc() -> subprocess.Popen:  # type: ignore[type-arg]
    command = (
        '/usr/bin/cvlc -vvv pulse://Sonos.monitor --sout '
        '#transcode{vcodec=none,acodec=flac,ab=1441,channels=2,samplerate=44100,scodec=none}'
        f':standard{{access=http,dst=0.0.0.0:{HTTP_PORT}/{STREAM_NAME}}}'
    )
    proc = subprocess.Popen(  # pylint: disable=consider-using-with
        command.split(" "),
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
    )
    return proc


def silence() -> subprocess.Popen:  # type: ignore[type-arg]
    # very light Pink noise to avoid sonos to cut when there is silence
    # c="ffplay -loglevel 24 -nodisp -autoexit -f lavfi -i anullsrc=r=44100:cl=mono"
    command = "ffplay -loglevel 24 -nodisp -autoexit -f lavfi -i anoisesrc=c=pink:r=44100:a=0.001"
    proc = subprocess.Popen(  # pylint: disable=consider-using-with
        command.split(" "),
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
    )
    return proc


def main() -> None:
    pa_sink_load()
    vlc_proc = vlc()
    silence_proc = silence()
    sonos = sonos_discover()
    volume = 45
    if len(sys.argv) > 1:
        volume = int(sys.argv[1])
    sonos_play(sonos, volume)
    fds = [vlc_proc.stdout.fileno(), vlc_proc.stderr.fileno()]
    try:
        while 1:
            ret = select.select(fds, [], [])
            for descriptor in ret[0]:
                buf = os.read(descriptor, 8192).decode('utf8')
                print(buf)
                if 'sink' in buf:
                    sonos_volume(sonos)
    except KeyboardInterrupt as error:
        print(f'Caught {error}')
        print('killing vlc')
        vlc_proc.terminate()
        os.system('killall ffplay')
        print('killing ffplay')
        silence_proc.terminate()
        os.system('killall vlc')
        print('unload pasink')
        pa_sink_unload()


main()
